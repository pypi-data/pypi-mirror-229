Refactor linearity correction to improve memory usage.
