{% extends "main/layout.html" %}
{% load static %}
{% block head %}


{% endblock head %}
{% block content %}
<div class="breadcrumb-holder">
	<div class="container-fluid">
		<ul class="breadcrumb">
			<li class="breadcrumb-item"><a href="{% url 'emp-dash' %}">PAINEL FUNCIONARIU</a></li>
			<li class="breadcrumb-item active">{{ legend|upper }}</li>
		</ul>
	</div>
</div>
<div class="container-fluid"><br/>
	<div class="row">
		<div class="col-sm-12">
			<div class="card shadow-lg border-info rounded">
				<div class="card-header border-primary">
					<center>
						<h2>{{ legend|upper }}</h2>
					</center>
				</div>
				<div class="card-body">
					{% if user_group == "admin" or user_group == "hr" %}
					<a class="btn btn-sm btn-primary mb-1" href="{% url 'emp-add' %}">Add Funcionariu <i class="fa fa-plus"></i></a>		
					<a class="btn btn-sm btn-danger mb-1" href="{% url 'emp-no-div' %}" target="_blank">Staff Seidauk iha Divisaun <i class="fa fa-users"></i></a>			
					<a class="btn btn-sm btn-warning mb-1" href="{% url 'emp-deactive-list' %}">Staff Desativu <i class="fa fa-users"></i></a>			
					<a class="btn btn-sm btn-secondary mb-1" href="{% url 'emp-rawdata' %}" target="_blank">Raw Data <i class="fa fa-list"></i></a>			
					{% endif %}
					<table id="example" class="table table-bordered table-sm responsive" style="width:100%">
						<thead>
							<tr align="center">
								<th>Nu.</th>
								<th class="text-left">Naran</th>
                <th>PIN</th>
								<th>Sexu</th>
								<th>Fatin & Data moris</th>
								<th>Idade</th>
								<th>Status</th>
							{% if obj.country.code == TLS %}
								<th>Municipality</th>
							{% else %}
								<th>City</th>
							{% endif %}
							</tr>
						</thead>
						<tbody>
						{% for obj in objects %}
							<tr align="center">
								<td>{{ forloop.counter }}</td>
								<td class="text-left"><a href="{% url 'emp-detail' obj.hashed %}">{{ obj.first_name }} {{ obj.last_name|upper }}</a></td>
								<td>{{ obj.pin }}</td>
                <td>{{ obj.sex }}</td>
								<td>{{ obj.pob }}, {{ obj.dob }}</td>
								<td>{{ obj.age }}</td>
								<td>{% if obj.is_science  %}Science{% else %}Non Science{% endif %}</td>
							{% if obj.country.code == "TLS" %}
								<td>{% if obj.locationtl.municipality %}{{ obj.locationtl.municipality }}{% endif %}</td>
							{% else %}
								<td>{% if obj.locationinter.city %}{{ obj.locationinter.city }}{% endif %}</td>
							{% endif %}
							</tr>
						{% endfor %}
						</tbody>
					</table>
				</div> <!--end card-body-->
			</div> <!--end card-->
		</div> <!--end col-->
	</div> <!--end row-->
</div>
{% endblock %}
{% block scripts %}
<script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.22/css/jquery.dataTables.min.css"/>
<script type="text/javascript" src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.1/xlsx.full.min.js"></script>

<link href="{% static 'main/vendor/datatables/css/searchBuilder.dataTables.min.css' %}" rel="stylesheet">
<link href="{% static 'main/vendor/datatables/css/searchBuilder.bootstrap4.min.css' %}" rel="stylesheet">
<link href="{% static 'main/vendor/datatables/css/buttons.dataTables.min.css' %}" rel="stylesheet">
<style type="text/css">
    .dtsb-searchBuilder{
        background: #b9c7e6 !important;
        padding: 5px
    }
    .dt-button, .dtsb-add {
        background: white !important;
    }
    .dt-buttons .dt-button {
        text-align: center !important;
    }
    .dt-print-view h1 {
        text-align: center;
        text-transform: uppercase;
        padding: 10px;
    }
</style>
<script src="{% static 'main/vendor/datatables/js/dataTables.searchBuilder.min.js' %}"></script>
<script src="{% static 'main/vendor/datatables/js/searchBuilder.bootstrap4.min.js' %}"></script>
<script src="{% static 'main/vendor/datatables/js/dataTables.buttons.min.js' %}"></script>
<script src="{% static 'main/vendor/datatables/js/jszip.min.js' %}"></script>
<script src="{% static 'main/vendor/datatables/js/pdfmake.min.js' %}"></script>
<script src="{% static 'main/vendor/datatables/js/vfs_fonts.js' %}"></script>
<script src="{% static 'main/vendor/datatables/js/buttons.html5.min.js' %}"></script>
<script src="{% static 'main/vendor/datatables/js/buttons.print.min.js' %}"></script>
<script src="{% static 'main/vendor/datatables/js/buttons.colVis.min.js' %}"></script>
<script type="text/javascript">
    $(document).ready( function () {
        var table = $('#example').removeAttr('width').DataTable( {
			dom: 'Bfrtip',
            "deferRender": true,
            "scrollY": "50vh",
            "scrollX": true,
            "scrollCollapse": true,
            "paging": true,
            searchBuilder: true,
            buttons:[
                {
                    extend: 'excelHtml5',
                    text: 'Export to Excel',
                    exportData: {
                        custom: function(data) {
                            exportDataTablesToExcel('#example', 'DataTables_Excel', '{{path}}');
                        }
                    }
                },
                {
                    extend: 'print',
                    exportOptions: { columns: ':visible' },
                    title: '{{legend}}',
                    messageTop: '',
                    customize: function ( win ) {
                        $(win.document.body)
                            .css( 'font-size', '10pt' )
                            .prepend(
                                '<center><img src="{{path}}" style="width:80%;" /></center><hr/>\
                                '
                            );
 
                        $(win.document.body).find( 'table' )
                            .addClass( 'compact' )
                            .css( 'font-size', 'inherit' );
                    
                    },
                },
                'colvis',
            ],
            
        });
        table.searchBuilder.container().prependTo(table.table().container());
    } );


function exportDataTablesToExcel(tableId, fileName, imageUrl) {
  console.log(imageUrl)
  console.log('FUNCTION CALLL')
  var table = $(tableId).DataTable();

  // Define the header styles
  var headerStyles = {
    font: {
      name: 'Arial',
      sz: 14,
      bold: true,
      color: 'FFFFFF'
    },
    fill: {
      fgColor: { rgb: '008000' }
    },
    border: {
      bottom: {
        style: 'thin',
        color: { rgb: 'FFFFFF' }
      }
    }
  };
  var workbook = XLSX.utils.book_new();
  // Get the table data
  var data = table.rows({ search: 'applied' }).data();
  var dataArray = [];
  data.each(function(value, index) {
    dataArray.push(value);
  });

  // Get the table header
  var header = table.columns().header();
  var headerArray = [];
  header.each(function(value, index) {
    headerArray.push(value.innerHTML);
  });

  // Define the cell styles
  var cellStyles = {
    font: {
      sz: 12,
      color: '000000'
    },
    fill: {
      fgColor: {
        rgb: 'FFFFFF'
      }
    }
  };

  // Create a worksheet
  var worksheet = XLSX.utils.aoa_to_sheet([headerArray].concat(dataArray));
  worksheet['!cols'] = [
    { wch: 20 },
    { wch: 20 },
    { wch: 20 },
    { wch: 20 },
    { wch: 20 },
    { wch: 20 }
  ];


  // Add header image
  worksheet['A1'] = {
    t: 's',
    v: 'Header Image',
    s: {
      fill: {
        type: 'pattern',
        pattern: 'solid',
        fgColor: { rgb: '00FF00' },
        bgColor: { indexed: 64 }
      },
      font: {
        color: { rgb: 'FFFFFF' }
      },
      alignment: {
        horizontal: 'center',
        vertical: 'center'
      }
    }
  };
  worksheet['A1'].s.image = {
    src: imageUrl,
    sx: 0.1,
    sy: 0.1,
    w: 250,
    h: 50
  };

  // Set the header styles
  worksheet['!merges'] = [{
    s: {
      r: 0,
      c: 0
    },
    e: {
      r: 0,
      c: 5
    }
  }];


  worksheet['A1'].s = headerStyles;
  worksheet['B1'].s = headerStyles;
  worksheet['C1'].s = headerStyles;
  worksheet['D1'].s = headerStyles;
  worksheet['E1'].s = headerStyles;
  worksheet['F1'].s = headerStyles;


  XLSX.utils.book_append_sheet(workbook, worksheet, 'Data');

  // Export the workbook
  XLSX.writeFile(workbook, fileName + '.xlsx');


}
</script>
{% endblock %}