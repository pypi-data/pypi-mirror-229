<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Qualification Task</title>
        <link rel='stylesheet' href='https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css'>
        <link rel='stylesheet' href='https://cdn.form.io/formiojs/formio.full.min.css'>
        <style type="text/css" >
            .col-form-label {
                font-weight: bold;
            }
        </style>
        <script src='https://cdn.form.io/formiojs/formio.full.min.js'></script>
    </head>
    <body>
        <script type="text/javascript">
            function generateSetCompletionQuestion(question_name, question_key, incomplete_set_url, option_a_url, option_b_url, option_c_url, option_d_url) {
                return {
                    "title": question_name,
                    "theme": "primary",
                    "tooltip": "Select which card completes the set shown below.",
                    "collapsible": false,
                    "key": question_key,
                    "type": "panel",
                    "label": "Panel",
                    "input": false,
                    "tableView": false,
                    "components": [
                        {
                            "label": "Set",
                            "tag": "img",
                            "attrs": [
                                {
                                    "attr": "src",
                                    "value": incomplete_set_url
                                },
                                {
                                    "attr": "alt",
                                    "value": "Set Completion Question"
                                },
                                {
                                    "attr": "width",
                                    "value": "400"
                                },
                                {
                                    "attr": "height",
                                    "value": "400"
                                }
                            ],
                            "refreshOnChange": false,
                            "key": "set",
                            "type": "htmlelement",
                            "input": false,
                            "tableView": false
                        },
                        {
                            "label": "AnswerTable",
                            "numRows": 1,
                            "numCols": 4,
                            "cellAlignment": "center",
                            "bordered": true,
                            "key": "answer-table",
                            "type": "table",
                            "input": false,
                            "tableView": false,
                            "rows": [
                                [
                                    {
                                        "components": [
                                            {
                                                "label": "option A",
                                                "tag": "img",
                                                "attrs": [
                                                    {
                                                        "attr": "src",
                                                        "value": option_a_url
                                                    },
                                                    {
                                                        "attr": "alt",
                                                        "value": "first option"
                                                    },
                                                    {
                                                        "attr": "width",
                                                        "value": "100"
                                                    },
                                                    {
                                                        "attr": "height",
                                                        "value": "100"
                                                    }
                                                ],
                                                "refreshOnChange": false,
                                                "key": "optionA",
                                                "type": "htmlelement",
                                                "input": false,
                                                "tableView": false
                                            },
                                            {
                                                "label": "HTML",
                                                "attrs": [
                                                    {
                                                        "attr": "style",
                                                        "value": "text-align:center"
                                                    }
                                                ],
                                                "content": "Option A",
                                                "refreshOnChange": false,
                                                "key": "html3",
                                                "type": "htmlelement",
                                                "input": false,
                                                "tableView": false
                                            }
                                        ]
                                    },
                                    {
                                        "components": [
                                            {
                                                "label": "HTML",
                                                "tag": "img",
                                                "attrs": [
                                                    {
                                                        "attr": "src",
                                                        "value": option_b_url
                                                    },
                                                    {
                                                        "attr": "alt",
                                                        "value": "option 2"
                                                    },
                                                    {
                                                        "attr": "height",
                                                        "value": "100"
                                                    },
                                                    {
                                                        "attr": "width",
                                                        "value": "100"
                                                    }
                                                ],
                                                "refreshOnChange": false,
                                                "key": "html",
                                                "type": "htmlelement",
                                                "input": false,
                                                "tableView": false
                                            },
                                            {
                                                "label": "HTML",
                                                "attrs": [
                                                    {
                                                        "attr": "style",
                                                        "value": "text-align:center"
                                                    }
                                                ],
                                                "content": "Option B",
                                                "refreshOnChange": false,
                                                "key": "html4",
                                                "type": "htmlelement",
                                                "input": false,
                                                "tableView": false
                                            }
                                        ]
                                    },
                                    {
                                        "components": [
                                            {
                                                "label": "HTML",
                                                "tag": "img",
                                                "attrs": [
                                                    {
                                                        "attr": "src",
                                                        "value": option_c_url
                                                    },
                                                    {
                                                        "attr": "alt",
                                                        "value": "option 3"
                                                    },
                                                    {
                                                        "attr": "height",
                                                        "value": "100"
                                                    },
                                                    {
                                                        "attr": "width",
                                                        "value": "100"
                                                    }
                                                ],
                                                "refreshOnChange": false,
                                                "key": "html1",
                                                "type": "htmlelement",
                                                "input": false,
                                                "tableView": false
                                            },
                                            {
                                                "label": "HTML",
                                                "attrs": [
                                                    {
                                                        "attr": "style",
                                                        "value": "text-align:center"
                                                    }
                                                ],
                                                "content": "Option C",
                                                "refreshOnChange": false,
                                                "key": "html5",
                                                "type": "htmlelement",
                                                "input": false,
                                                "tableView": false
                                            }
                                        ]
                                    },
                                    {
                                        "components": [
                                            {
                                                "label": "HTML",
                                                "tag": "img",
                                                "attrs": [
                                                    {
                                                        "attr": "src",
                                                        "value": option_d_url
                                                    },
                                                    {
                                                        "attr": "alt",
                                                        "value": "option 4"
                                                    },
                                                    {
                                                        "attr": "height",
                                                        "value": "100"
                                                    },
                                                    {
                                                        "attr": "width",
                                                        "value": "100"
                                                    }
                                                ],
                                                "refreshOnChange": false,
                                                "key": "html2",
                                                "type": "htmlelement",
                                                "input": false,
                                                "tableView": false
                                            },
                                            {
                                                "label": "HTML",
                                                "attrs": [
                                                    {
                                                        "attr": "style",
                                                        "value": "text-align:center"
                                                    }
                                                ],
                                                "content": "Option D",
                                                "refreshOnChange": false,
                                                "key": "html6",
                                                "type": "htmlelement",
                                                "input": false,
                                                "tableView": false
                                            }
                                        ]
                                    }
                                ]
                            ]
                        },
                        {
                            "label": "Answer",
                            "optionsLabelPosition": "right",
                            "inline": false,
                            "tableView": false,
                            "values": [
                                {
                                    "label": "Option A",
                                    "value": "optionA",
                                    "shortcut": ""
                                },
                                {
                                    "label": "Option B",
                                    "value": "optionB",
                                    "shortcut": ""
                                },
                                {
                                    "label": "Option C",
                                    "value": "optionC",
                                    "shortcut": ""
                                },
                                {
                                    "label": "Option D",
                                    "value": "optionD",
                                    "shortcut": ""
                                }
                            ],
                            "key": question_key + "-answer",
                            "type": "radio",
                            "input": true
                        }
                    ]
                };
            }
            var form_data = {
                "display": "form",
                "settings": {
                    "pdf": {
                        "id": "1ec0f8ee-6685-5d98-a847-26f67b67d6f0",
                        "src": "https://files.form.io/pdf/5692b91fd1028f01000407e3/file/1ec0f8ee-6685-5d98-a847-26f67b67d6f0"
                    }
                },
                "components": [
                    {
                        "label": "Follower Survey, True/False (Answer these questions as the follower).",
                        "description": "",
                        "tableView": false,
                        "questions": [
                            {
                                "label": "My priority is to follow the leader's instructions",
                                "value": "myPriorityIsToFollowTheLeadersInstructions",
                                "tooltip": ""
                            },
                            {
                                "label": "If an instruction is unclear, I should do my best.",
                                "value": "ifAnInstructionIsUnclearIShouldDoMyBestAndHopeForClarificationInTheNextInstruction",
                                "tooltip": ""
                            },
                            {
                                "label": "If the leader missed something obvious, I should ignore the leader's instructions because I know better",
                                "value": "ifTheLeaderMissedSomethingObviousIShouldIgnoreTheLeadersInstructionsBecauseIKnowBetter",
                                "tooltip": ""
                            },
                            {
                                "label": "The game ends when we run out of turns",
                                "value": "theGameEndsWhenWeRunOutOfTurns",
                                "tooltip": ""
                            },
                            {
                                "label": "If I run out of moves, my turn ends instantly",
                                "value": "ifIRunOutOfMovesMyTurnEndsInstantly",
                                "tooltip": ""
                            }
                        ],
                        "values": [
                            {
                                "label": "True",
                                "value": "true",
                                "tooltip": ""
                            },
                            {
                                "label": "False",
                                "value": "false",
                                "tooltip": ""
                            }
                        ],
                        "key": "followerSurveyTrueFalse",
                        "type": "survey",
                        "input": true
                    },
                    {
                        "label": "Leader Survey, True/False (Answer these questions as the leader).",
                        "description": "",
                        "tableView": false,
                        "questions": [
                            {
                                "label": "My primary goal is to give instructions to the follower and move around to collect sets of 3 unique cards together with the follower.",
                                "value": "myPrimaryGoalIsToGiveInstructionsToTheFollowerAndMoveAroundToCollectASetOf3UniqueCards",
                                "tooltip": ""
                            },
                            {
                                "label": "If I do not leave an instruction for the follower, their turn will be skipped when my turn runs out of time.",
                                "value": "ifIDoNotLeaveAnInstructionForTheFollowerTheirTurnWillBeSkippedWhenMyTurnRunsOutOfTime",
                                "tooltip": ""
                            },
                            {
                                "label": "If the follower misunderstands an instruction, I should get impatient and angry at them.",
                                "value": "ifTheFollowerMisunderstandsAnInstructionIShouldGetImpatientAndAngryAtThem",
                                "tooltip": ""
                            },
                            {
                                "label": "My turn is over once I run out of moves.",
                                "value": "myTurnIsOverOnceIRunOutOfMoves",
                                "tooltip": "Note! This is different from when playing as the follower. As the leader, you may also leave an instruction for the follower before ending your turn."
                            },
                            {
                                "label": "My turn is over once I run out of time.",
                                "value": "myTurnIsOverOnceIRunOutOfTime",
                                "tooltip": ""
                            },
                            {
                                "label": "The game is over when we run out of turns.",
                                "value": "theGameIsOverWhenWeRunOutOfTurns",
                                "tooltip": ""
                            }
                        ],
                        "values": [
                            {
                                "label": "True",
                                "value": "true",
                                "tooltip": ""
                            },
                            {
                                "label": "False",
                                "value": "false",
                                "tooltip": ""
                            }
                        ],
                        "key": "leaderSurveyTrueFalse",
                        "type": "survey",
                        "input": true
                    },
                    generateSetCompletionQuestion("Set Completion Question 1: Select the card that creates a unique set.", "setCompletionQuestion1", "/images/question-1.png", "/images/question-1-option-a.png", "/images/question-1-option-b.png", "/images/question-1-option-c.png", "/images/question-1-option-d.png"),
                    generateSetCompletionQuestion("Set Completion Question 2: Select the card that creates a unique set.", "setCompletionQuestion2", "/images/question-2.png", "/images/question-2-option-a.png", "/images/question-2-option-b.png", "/images/question-2-option-c.png", "/images/question-2-option-d.png"),
                    generateSetCompletionQuestion("Set Completion Question 3: Select the card that creates a unique set.", "setCompletionQuestion3", "/images/question-3.png", "/images/question-3-option-a.png", "/images/question-3-option-b.png", "/images/question-3-option-c.png", "/images/question-3-option-d.png"),
                    generateSetCompletionQuestion("Set Completion Question 4: Select the card that creates a unique set.", "setCompletionQuestion4", "/images/question-4.png", "/images/question-4-option-a.png", "/images/question-4-option-b.png", "/images/question-4-option-c.png", "/images/question-4-option-d.png"),
                    generateSetCompletionQuestion("Set Completion Question 5: Select the card that creates a unique set.", "setCompletionQuestion5", "/images/question-5.png", "/images/question-5-option-a.png", "/images/question-5-option-b.png", "/images/question-5-option-c.png", "/images/question-5-option-d.png"),
                    {
                        "type": "button",
                        "label": "Submit",
                        "key": "submit",
                        "disableOnInvalid": true,
                        "input": true,
                        "tableView": false
                    }
                ]
            };
        </script>
        <script type="text/javascript">
            function validPreviewParams(params) {
                if (!params.has('assignmentId')) {
                    console.log('Missing assignmentId parameter.');
                    return false;
                }
                if (params.get('assignmentId') != 'ASSIGNMENT_ID_NOT_AVAILABLE') {
                    console.log('Not in preview mode.');
                    return false;
                }
                return true;
            }
            function validWorkerParams(params) {
                if (!params.has('workerId')) {
                    console.log('Missing workerId parameter.');
                    return false;
                }
                if (!params.has('assignmentId')) {
                    console.log('Missing assignmentId parameter.');
                    return false;
                }
                if (!params.has('turkSubmitTo'))
                {
                    console.log('Missing turkSubmitTo parameter.');
                    return false;
                }
                return true;
            }

            function renderForm(params) {
                var htmlForm = document.getElementById('qual-form');
                Formio.createForm(htmlForm, form_data).then(function(form) {
                    form.nosubmit = true;
                    form.options.noAlerts = true;

                    form.on('submit', function(submission) {
                        var htmlForm = document.createElement('form');
                        htmlForm.action = (new URL('mturk/externalSubmit', params.get('turkSubmitTo'))).href
                        console.log(htmlForm.action);
                        htmlForm.method = 'post';

                        // Add the assignment ID to the form.
                        var assignmentIdInput = document.createElement("input");
                        assignmentIdInput.setAttribute("type", "hidden");
                        assignmentIdInput.setAttribute("name", "assignmentId");
                        assignmentIdInput.setAttribute("value", params.get('assignmentId'));
                        htmlForm.appendChild(assignmentIdInput);

                        // Add the form data to the form.
                        var formDataInput = document.createElement("input");
                        formDataInput.setAttribute("type", "hidden");
                        formDataInput.setAttribute("name", "formData");
                        formDataInput.setAttribute("value", JSON.stringify(submission));
                        htmlForm.appendChild(formDataInput);

                        // Submit the form.
                        document.body.appendChild(htmlForm);
                        htmlForm.submit();

                        form.emit('submitDone', submission)
                    });
                });
            }

            window.onload = function() {
                var params = new URLSearchParams(window.location.search);
                var statusElement = document.getElementById('status');
                RewriteFollowerTutorialLink();
                RewriteLeaderTutorialLink();
                if (validWorkerParams(params)) {
                    statusElement.innerHTML = 'Valid Amazon MTurk parameters. Proceed to task.';
                    statusElement.style.backgroundColor = '#7FFFD4';
                    var form = document.getElementById('qual-form');
                    renderForm(params);
                } else if (validPreviewParams(params)) {
                        statusElement.innerHTML = 'MTurk PREVIEW. You can preview the form, but you cannot submit it.';
                        statusElement.style.backgroundColor = 'yellow';
                } else {
                    statusElement.innerHTML = 'Missing Amazon MTurk parameters. Did you access this page through mechanical turk?';
                    statusElement.style.backgroundColor = 'red';
                }
            }

            function RewriteLinkWithForwardParams(link_id, url) {
                var mturkParameters = new URLSearchParams(window.location.search);
                var link = document.getElementById(link_id);
                link.href = url + "&" + mturkParameters.toString();
            }

            function RewriteLeaderTutorialLink() {
                RewriteLinkWithForwardParams("leader-link", "https://cerealbar2.com/?skipToTask=leaderTutorial&lobby_name=mturk-lobby");
            }

            function RewriteFollowerTutorialLink() {
                RewriteLinkWithForwardParams("follower-link", "https://cerealbar2.com/?skipToTask=followerTutorial&lobby_name=mturk-lobby");
            }
        </script>
        <div>
            <h1>Qualification Task</h1>
            <h2 id="status"></h2>
            <h2 style="background:yellow;"> Please make sure you aren't reserving more than 1 HIT at a time with Panda. 1 HIT per worker only. </h2>
            <h2>
                Qualification Steps
            </h2>
            <ol>
                <li><a id="follower-link" href="#" target="_blank">Click here</a> to take the follower tutorial (4m Estimated).</li>
                <li><a id="leader-link" href="#" target="_blank">Click here</a> to take the leader tutorial (7m Estimated).</li>
                <li><a id="" href="/example_sets" target="_blank">Click here</a> to read the set-making rules (2m Estimated).</li>
                <li>Take the qualification test (below)</li>
            </ol>
            <p style="background-color: rgb(255, 255, 170); font-size: 15px; display: block; margin-left: auto; margin-right: auto; text-align: center; width: 60%;">
                You are <b>strongly</b> encouraged to
                <a href="https://discord.gg/YtFcCpKqfa" target="_blank">join the discord</a> for
                support, updates and <b>notifications of new assignments</b>.
            </p>
            <h2>
                Qualification Test
            </h2>
            <em style="color: grey; margin-left: 10px;">If you forget anything, feel free to consult <a target="_blank" href="/rules">the rules</a>
                while you take this test. <b>If you pass the test, you will receive a bonus.</b></em>
            <form id="qual-form" method="post"></form>
    </body>
</html>
