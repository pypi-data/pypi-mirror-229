#
#  .gitlab-ci.yml
#
#    Gitlab CI build configuration.
#
#  Copyright (C) 2021 by
#  Nikhil Ramakrishnan.
#
#  This file is part of the FreeType project, and may only be used,
#  modified, and distributed under the terms of the FreeType project
#  license, LICENSE.TXT.  By continuing to use, modify, or distribute
#  this file you indicate that you have read the license and
#  understand and accept it fully.

.rules-default: &rules-default
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS'
      when: never
    - if: '$CI_COMMIT_BRANCH'
    - if: '$CI_COMMIT_TAG'

.tests: &tests
  <<: *rules-default
  before_script:
    - python -V
    - pip install tox
  script:
    - tox

.regression: &regression
  <<: *rules-default
  before_script:
    - python -V
    - pip install tox
    - apt-get -qq update && apt-get -qq install -y clang autoconf cmake libtool
  script:
    - tox

.deploy: &deploy
  before_script:
   - pip install twine
  script:
    - python setup.py sdist bdist_wheel
    - twine upload dist/*

test-python38:
  <<: *tests
  image: python:3.8
  variables:
    TOXENV: "py38"
  stage: test

test-python39:
  <<: *tests
  image: python:3.9
  variables:
    TOXENV: "py39"
  stage: test

test-regression:
  <<: *regression
  image: python:3.8
  variables:
    TOXENV: "regression"
  stage: test

deploy-PyPI:
  <<: *deploy
  image: python:3.8
  variables:
    TWINE_USERNAME: $PYPI_PRODUCTION_USERNAME
    TWINE_PASSWORD: $PYPI_PRODUCTION_PASSWORD
  rules:
    - if: '$CI_COMMIT_TAG && $CI_PROJECT_PATH == "freetype/docwriter"'
      when: always
    - when: never
  stage: deploy
