"use strict";(self.webpackChunkjupyterlab_box_drive=self.webpackChunkjupyterlab_box_drive||[]).push([[611],{611:(e,t,a)=>{a.r(t),a.d(t,{default:()=>h});var n=a(303),o=a(122),i=a(720),s=a(745),r=a(139),d=a(344),c=a(840);class l{constructor(){this._isDisposed=!1,this._fileChanged=new c.Signal(this),this._boxAbsPathMap=new Map([["",{id:"0",isdir:!0}],["/",{id:"0",isdir:!0}]]),this._accessToken=""}get isDisposed(){return this._isDisposed}dispose(){this.isDisposed||(this._isDisposed=!0,c.Signal.clearData(this))}set accessToken(e){this._accessToken=e}get name(){return"Box"}get serverSettings(){return r.ServerConnection.makeSettings()}get fileChanged(){return this._fileChanged}async get(e,t){if(!(t&&"content"in t&&t.content)&&this._boxAbsPathMap.has(e))return{name:d.PathExt.basename(e),path:e,last_modified:"",created:"",format:null,mimetype:"",content:null,writable:!0,type:this._boxAbsPathMap.get(e).isdir?"directory":"file"};var a=new((new BoxSdk).BasicBoxClient)({accessToken:this._accessToken,noRequestMode:!0}),n=await this.get_file_id(e);if(t&&"type"in t&&("file"==t.type||"notebook"==t.type))return this.get_file_content(a,n,e,t);var o=a.folders.get({id:n,params:{fields:"name,item_collection"}}),i=await fetch(o.url,{method:o.method,headers:o.headers,mode:o.mode,cache:"no-store"});if(!i.ok&&404==i.status)return this.get_file_content(a,n,e,t);const s=await i.json(),r=[];for(const t of s.item_collection.entries)if("file"==t.type){var c="file";".ipynb"==d.PathExt.extname(t.name)&&(c="notebook"),r.push({name:t.name,path:this.get_abspath_and_set_to_map(e,t.name,t.id,!1),created:"",last_modified:"",format:null,mimetype:"",content:null,writable:!0,type:c})}else r.push({name:t.name,path:this.get_abspath_and_set_to_map(e,t.name,t.id,!0),created:"",last_modified:"",format:null,mimetype:"",content:null,writable:!0,type:"directory"});return{name:s.name,path:e,last_modified:"",created:"",format:null,mimetype:"",content:r,size:void 0,writable:!0,type:"directory"}}async getDownloadUrl(e){var t=new((new BoxSdk).BasicBoxClient)({accessToken:this._accessToken,noRequestMode:!0});const a=await this.get_file_id(e);var n=t.files.getDownloadUrl({id:a}),o=await fetch(n.url,{method:n.method,headers:n.headers,mode:n.mode,cache:"no-store"});const i=await o.json();if(!o.ok)throw new Error;return i.download_url}async newUntitled(e){var t=new((new BoxSdk).BasicBoxClient)({accessToken:this._accessToken,noRequestMode:!0});let a="";e&&e.path&&(a=e.path);const n=(null==e?void 0:e.type)||"directory";var o="directory"===n?"Untitled Folder":"untitled";const i=(null==e?void 0:e.ext)||"txt",s=new Date;var r,c;const l="directory"===n;if(l)throw new Error("Method not implemented.");for(let e=0;;e++){const n=`${0==e?`${o}`:`${o} ${e}`}${i}`;r=d.PathExt.join(a,n);let l=d.PathExt.dirname(r);var h=new FormData;h.append("parent_id",await this.get_file_id(l));const m=await this.upload_file_content(t,n,"",h,s);if(m.ok||409!=m.status){c=(await m.json()).entries[0],console.log(c);break}}let m={name:c.name,path:this.get_abspath_and_set_to_map(a,c.name,c.id,l),created:new Date(c.content_created_at).toISOString(),last_modified:new Date(c.content_created_at).toISOString(),format:"text",mimetype:"",content:null,writable:!0,type:"file"};return this._fileChanged.emit({type:"new",oldValue:null,newValue:m}),m}async delete(e){var t=new((new BoxSdk).BasicBoxClient)({accessToken:this._accessToken,noRequestMode:!0});const a=await this.get_file_id(e),n=await t.files.delete({id:a});if(!(await fetch(n.url,{method:n.method,headers:n.headers,mode:n.mode,cache:"no-store"})).ok)throw new Error;this.delete_from_map(e)}async rename(e,t){var a=new((new BoxSdk).BasicBoxClient)({accessToken:this._accessToken,noRequestMode:!0});const n=await this.get_file_id(e),o=this.get_file_name(t);let i=d.PathExt.dirname(e);const s=await a.files.updateInfo({id:n,name:o});var r=await fetch(s.url,{method:s.method,headers:s.headers,mode:s.mode,body:s.body,cache:"no-store"});const c=await r.json();return this.get_abspath_and_set_to_map(i,o,n,this._boxAbsPathMap.get(e).isdir),{name:o,path:t,created:new Date(c.content_created_at).toISOString(),last_modified:new Date(c.content_modified_at).toISOString(),format:"text",mimetype:"",content:null,writable:!0,type:"file"}}async save(e,t){var a=null==t?void 0:t.format;const n=null==t?void 0:t.content;var o=new((new BoxSdk).BasicBoxClient)({accessToken:this._accessToken,noRequestMode:!0});let i=d.PathExt.basename(e),s=d.PathExt.dirname(e);var r;"base64"==a?r=await function(e,t="text/plain;charset=UTF-8"){return fetch(`data:${t};base64,`+e).then((e=>e.blob()))}(n):"json"==a?r=JSON.stringify(n,null,2):("text"==a||(a="text"),r=n);var c,l=new FormData;t&&"name"in t?(c=i,l.append("parent_id",await this.get_file_id(s))):(c=this.get_file_name(e),l.append("id",await this.get_file_id(e)));const h=new Date,m=await this.upload_file_content(o,c,r,l,h);console.log(m);const _=await m.json();let p;console.log(_),this._fileChanged.emit({type:"save",oldValue:null,newValue:r});try{var u=await this.get_file_id(e);p=await this.get_file_content(o,u,e,t,h)}catch(t){p={name:c,path:e,created:h.toISOString(),last_modified:h.toISOString(),format:a,mimetype:"",content:null,writable:!0,type:"file"}}return p}async copy(e,t){var a=new((new BoxSdk).BasicBoxClient)({accessToken:this._accessToken,noRequestMode:!0});let n=d.PathExt.basename(e),o=d.PathExt.dirname(e);const i=await this.get_file_id(e),s=await this.get_file_id(t),r=d.PathExt.extname(n),c=n.slice(0,n.length-r.length);for(let e=o===t?1:0;;e++){const n=`${0==e?`${c}`:`${c} ${e}`}${r}`,o=await a.files.copy({id:i,name:n,body:{parent:{id:s}}});var l=await fetch(o.url,{method:o.method,headers:o.headers,mode:o.mode,body:o.body,cache:"no-store"});if(!l.ok&&409==l.status)continue;const d=await l.json(),h=this.get_abspath_and_set_to_map(t,n,d.id,!1);return{name:d.name,path:h,last_modified:new Date(d.content_modified_at).toISOString(),created:new Date(d.content_created_at).toISOString(),format:null,mimetype:"",content:"",writable:!0,type:"file"}}}async createCheckpoint(e){return{id:"test",last_modified:(new Date).toISOString()}}async listCheckpoints(e){return[{id:"test",last_modified:(new Date).toISOString()}]}restoreCheckpoint(e,t){return Promise.resolve(void 0)}deleteCheckpoint(e,t){return Promise.resolve(void 0)}async get_file_content(e,t,a,n,o){var i=e.files.get({id:t,params:{fields:["id","name","content_created_at","content_modified_at","extension","item_status","lock","metadata","parent","path_collection","size"].join(",")}}),s=await fetch(i.url,{method:i.method,headers:i.headers,mode:i.mode,cache:"no-store"});const r=await s.json();if(!s.ok)throw new Error;const c=new URL(i.url);var l=[c.protocol,"//",c.host,c.pathname+"/content"].join(""),h=await fetch(l,{method:i.method,headers:i.headers,mode:i.mode,cache:"no-store"});let m,_;m=n&&"type"in n&&n.type?n.type:"file";var p,u,f=h.headers.get("content-type");return null==f?(f="text/plain",_="text"):["ipynb"].includes(r.extension)?(f="",_="json"):["md","yml","yaml","json","py"].includes(r.extension)||["application/x-javascript","image/svg+xml"].includes(f)?(f="text/plain",_="text"):_="application/json"==f?"json":f&&f.split("/")?["text"].includes(f.split("/")[0])?"text":"base64":"text",p="text"==_?await h.text():"notebook"==m.toString()?await h.json():function(e){let t="";const a=new Uint8Array(e);for(let e=0;e<a.byteLength;e++)t+=String.fromCharCode(a[e]);return window.btoa(t)}(await h.arrayBuffer()),u=o?o.toISOString():new Date(r.content_modified_at).toISOString(),{name:r.name,path:d.PathExt.join(a,r.name),created:new Date(r.content_created_at).toISOString(),last_modified:u,format:_,mimetype:f,content:p,writable:!0,type:m}}async upload_file_content(e,t,a,n,o){const i=new File([a],t,{type:"",lastModified:o.getTime()});n.append(t,i);const s=await e.files.upload({body:n});return s.headers&&"Content-Type"in s.headers&&delete s.headers["Content-Type"],await fetch(s.url,{method:s.method,headers:s.headers,body:s.body,mode:s.mode,cache:"no-store"})}async get_file_id(e){var t,a;let n=null===(t=this._boxAbsPathMap.get(e))||void 0===t?void 0:t.id;if(n)return n;let o=d.PathExt.dirname(e);if(!o)return await this.get("",{content:!0}),"0";if(await this.get_file_id(o),await this.get(o,{content:!0}),n=null===(a=this._boxAbsPathMap.get(e))||void 0===a?void 0:a.id,n)return n;throw new Error("ID not found for path")}get_abspath_and_set_to_map(e,t,a,n){const o=d.PathExt.join(e,t);return this._boxAbsPathMap.set(o,{id:a,isdir:n}),o}delete_from_map(e){this._boxAbsPathMap.delete(e)}get_file_name(e){return d.PathExt.basename(e)}}const h={id:"jupyterlab-box-drive:plugin",requires:[o.IFileBrowserFactory,i.ITranslator],autoStart:!0,activate:(e,t,a)=>{console.log("JupyterLab extension jupyterlab-box-drive is activated!");const o=function(){if(document.currentScript)return document.currentScript.src;var e=document.getElementsByTagName("script"),t=e[e.length-1];return t.src?t.src+"../../../../":"/lab/extensions/"}()+"jupyterlab-box-drive/static/assets/",{serviceManager:i}=e,{createFileBrowser:r}=t,d=a.load("jupyterlab-box-drive");!function(e){let t=document.createElement("script");t.setAttribute("src",e),t.setAttribute("type","text/javascript"),document.body.appendChild(t)}(o+"BoxSdk.min.js");const c=new l;i.contents.addDrive(c);const h=r("jp-box-browser",{driveName:c.name,restore:!0});h.title.caption=d.__("Box"),h.title.icon=s.treeViewIcon;const m=new n.ToolbarButton({icon:s.launchIcon,onClick:async()=>{f=window.open(o+"auth.html","BoxAuth","width=600,height=600")},tooltip:d.__("Box | Login"),label:d.__("Box | Login")});h.toolbar.insertItem(0,"get-token",m),m.removeClass("jp-Toolbar-item"),m.addClass("jp-Toolbar-item-BoxDrive"),e.shell.add(h,"left");var _,p,u,f=null,w="",g=0;const y=async function(){var e=new FormData;e.append("client_id",p),e.append("client_secret",u),e.append("grant_type","refresh_token"),e.append("refresh_token",w);var t=await fetch(_,{method:"POST",body:e});const a=await t.json();if(!t.ok)throw new Error(a);w=a.refresh_token,g=(new Date).getTime()+1e3*a.expires_in,c.accessToken=a.access_token},b=async function(){try{f&&f.RefreshToken?(_=f.TokenEndpoint,p=f.ClientID,u=f.ClientSecret,w=f.RefreshToken,await y(),f.close(),f=null):w&&g>0&&(new Date).getTime()+6e5>g&&await y()}catch(e){console.error(e)}setTimeout(b,3e3)};b()}}}}]);